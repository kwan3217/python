import numpy as np
import scipy.misc
import scipy.ndimage
import matplotlib.image as mpimg
import matplotlib.pyplot as plt
from PIL import Image

Ranger7A_Reticle=(None,
                  (1150, 1126, 562, 477, 1061, 476, 564, 970),
                  (1150, 1129, 561, 481, 1059, 482, 560, 974),
                  (1150, 1118, 563, 469, 1059, 465, 565, 962),
                  (1150, 1121, 564, 473, 1065, 472, 567, 969),
                  (1150, 1123, 564, 481, 1065, 478, 567, 976),
                  (1150, 1117, 562, 477, 1060, 478, 562, 969),
                  (1150, 1125, 565, 483, 1065, 483, 567, 979),
                  (1150, 1123, 565, 470, 1064, 468, 567, 962),
                  (1150, 1125, 565, 474, 1064, 476, 564, 968),
                  (1150, 1125, 562, 470, 1061, 470, 563, 963),
                  (1150, 1123, 566, 471, 1061, 468, 568, 962),
                  (1150, 1117, 565, 471, 1062, 469, 567, 962),
                  (1150, 1122, 568, 469, 1066, 466, 572, 963),
                  (1150, 1123, 563, 474, 1062, 471, 567, 966),
                  (1150, 1130, 565, 478, 1064, 477, 564, 972),
                  (1150, 1122, 565, 472, 1063, 471, 567, 964),
                  (1150, 1120, 565, 473, 1061, 471, 566, 964),
                  (1150, 1121, 564, 470, 1060, 468, 566, 963),
                  (1150, 1122, 567, 467, 1064, 465, 568, 959),
                  (1150, 1119, 562, 466, 1062, 461, 567, 959),
                  (1150, 1126, 565, 470, 1064, 469, 567, 965),
                  (1150, 1123, 564, 472, 1062, 469, 566, 965),
                  (1150, 1117, 565, 465, 1059, 463, 568, 956),
                  (1150, 1120, 565, 470, 1060, 469, 566, 961),
                  (1150, 1126, 569, 474, 1066, 471, 571, 968),
                  (1150, 1117, 565, 469, 1059, 466, 568, 961),
                  (1150, 1129, 570, 472, 1066, 468, 574, 966),
                  (1150, 1126, 566, 473, 1062, 470, 569, 966),
                  (1150, 1129, 566, 469, 1063, 467, 570, 962),
                  (1150, 1128, 567, 468, 1064, 467, 568, 962),
                  (1150, 1126, 560, 471, 1058, 469, 563, 965),
                  (1150, 1123, 561, 469, 1056, 467, 563, 962),
                  (1150, 1123, 566, 467, 1062, 467, 566, 959),
                  (1150, 1123, 563, 473, 1058, 472, 564, 966),
                  (1150, 1119, 565, 468, 1059, 463, 570, 961),
                  (1150, 1125, 561, 470, 1057, 470, 563, 962),
                  (1150, 1130, 564, 472, 1063, 469, 566, 968),
                  (1150, 1123, 562, 472, 1057, 472, 564, 964),
                  (1150, 1125, 564, 471, 1061, 469, 566, 965),
                  (1150, 1126, 563, 470, 1060, 471, 565, 964),
                  (1150, 1125, 569, 474, 1064, 468, 574, 965),
                  (1150, 1126, 564, 470, 1061, 469, 566, 963),
                  (1150, 1127, 564, 470, 1061, 465, 570, 966),
                  (1150, 1120, 563, 466, 1060, 463, 567, 960),
                  (1150, 1120, 562, 467, 1057, 468, 563, 960),
                  (1150, 1115, 565, 466, 1060, 466, 565, 958),
                  (1150, 1113, 565, 466, 1061, 464, 567, 959),
                  (1150, 1122, 562, 469, 1060, 468, 564, 963),
                  (1150, 1118, 564, 465, 1059, 461, 569, 957),
                  (1150, 1119, 563, 466, 1059, 466, 563, 960),
                  (1150, 1127, 563, 473, 1061, 470, 567, 969),
                  (1150, 1118, 563, 466, 1059, 463, 567, 959),
                  (1150, 1123, 566, 470, 1066, 468, 570, 965),
                  (1150, 1123, 564, 469, 1062, 465, 568, 964),
                  (1150, 1122, 568, 468, 1064, 467, 569, 961),
                  (1150, 1121, 562, 466, 1058, 465, 562, 960),
                  (1150, 1119, 565, 471, 1062, 468, 568, 965),
                  (1150, 1129, 562, 470, 1059, 468, 563, 962),
                  (1150, 1123, 564, 470, 1060, 465, 568, 963),
                  (1150, 1123, 565, 474, 1062, 472, 567, 968),
                  (1150, 1128, 563, 471, 1060, 467, 567, 964),
                  (1150, 1125, 565, 470, 1063, 465, 569, 963),
                  (1150, 1119, 567, 470, 1063, 469, 568, 963),
                  (1150, 1121, 566, 468, 1063, 465, 570, 960),
                  (1150, 1125, 566, 470, 1064, 469, 567, 964),
                  (1150, 1118, 564, 470, 1062, 468, 565, 964),
                  (1150, 1123, 567, 470, 1063, 468, 569, 963),
                  (1150, 1117, 566, 466, 1061, 464, 569, 958),
                  (1150, 1126, 566, 473, 1067, 471, 569, 968),
                  (1150, 1117, 568, 469, 1065, 467, 569, 961),
                  (1150, 1122, 564, 469, 1060, 468, 567, 962),
                  (1150, 1120, 566, 467, 1064, 466, 567, 960),
                  (1150, 1124, 563, 469, 1059, 467, 565, 962),
                  (1150, 1122, 564, 470, 1060, 470, 563, 963),
                  (1150, 1121, 565, 470, 1062, 466, 569, 964),
                  (1150, 1122, 563, 467, 1060, 464, 566, 959),
                  (1150, 1118, 565, 466, 1064, 464, 568, 960),
                  (1150, 1119, 566, 470, 1063, 468, 568, 963),
                  (1150, 1123, 566, 471, 1063, 469, 567, 965),
                  (1150, 1123, 566, 470, 1063, 467, 569, 962),
                  (1150, 1121, 566, 470, 1063, 469, 567, 963),
                  (1150, 1117, 566, 465, 1063, 465, 566, 958),
                  (1150, 1119, 564, 464, 1059, 465, 564, 956),
                  (1150, 1125, 562, 468, 1060, 466, 565, 961),
                  (1150, 1123, 561, 467, 1057, 465, 564, 959),
                  (1150, 1120, 566, 465, 1064, 464, 568, 958),
                  (1150, 1119, 561, 471, 1059, 470, 563, 964),
                  (1150, 1119, 563, 466, 1059, 466, 563, 958),
                  (1150, 1126, 565, 470, 1061, 469, 565, 962),
                  (1150, 1126, 563, 472, 1060, 470, 565, 966),
                  (1150, 1127, 568, 470, 1063, 469, 570, 963),
                  (1150, 1119, 562, 468, 1058, 465, 564, 960),
                  (1150, 1119, 565, 469, 1061, 466, 568, 961),
                  (1150, 1123, 567, 468, 1063, 465, 570, 961),
                  (1150, 1124, 563, 469, 1058, 467, 565, 962),
                  (1150, 1123, 562, 469, 1062, 468, 563, 965),
                  (1150, 1120, 565, 468, 1060, 466, 567, 960),
                  (1150, 1120, 566, 468, 1061, 464, 570, 960),
                  (1150, 1127, 564, 471, 1061, 470, 566, 966),
                  (1150, 1124, 567, 469, 1065, 470, 566, 963),
                  (1150, 1124, 564, 475, 1063, 475, 564, 970),
                  (1150, 1119, 564, 466, 1061, 464, 566, 959),
                  (1150, 1122, 565, 467, 1059, 463, 568, 958),
                  (1150, 1119, 563, 467, 1059, 464, 565, 959),
                  (1150, 1123, 563, 470, 1059, 468, 565, 965),
                  (1150, 1114, 564, 467, 1059, 465, 566, 959),
                  (1150, 1119, 568, 467, 1063, 466, 569, 959),
                  (1150, 1126, 564, 468, 1062, 465, 567, 962),
                  (1150, 1116, 566, 464, 1061, 462, 569, 955),
                  (1150, 1119, 563, 468, 1060, 464, 566, 960),
                  (1150, 1119, 563, 467, 1060, 463, 568, 961),
                  (1150, 1120, 565, 468, 1062, 468, 565, 961),
                  (1150, 1116, 567, 469, 1063, 469, 567, 961),
                  (1150, 1120, 566, 468, 1062, 466, 569, 961),
                  (1150, 1117, 556, 469, 1049, 468, 556, 959),
                  (1150, 1123, 564, 469, 1063, 467, 568, 964),
                  (1150, 1121, 566, 470, 1065, 468, 569, 963),
                  (1150, 1117, 569, 468, 1064, 467, 571, 960),
                  (1150, 1123, 566, 472, 1062, 469, 568, 964),
                  (1150, 1122, 567, 472, 1065, 470, 570, 965),
                  (1150, 1121, 566, 467, 1062, 464, 569, 960),
                  (1150, 1125, 567, 471, 1062, 468, 569, 965),
                  (1150, 1121, 568, 470, 1062, 466, 570, 963),
                  (1150, 1123, 566, 475, 1061, 472, 568, 968),
                  (1150, 1117, 568, 474, 1063, 470, 572, 965),
                  (1150, 1120, 568, 471, 1065, 469, 570, 965),
                  (1150, 1120, 569, 471, 1065, 470, 570, 963),
                  (1150, 1118, 568, 467, 1064, 466, 569, 959),
                  (1150, 1117, 566, 472, 1062, 470, 568, 964),
                  (1150, 1121, 565, 469, 1061, 467, 566, 962),
                  (1150, 1118, 567, 468, 1061, 466, 569, 958),
                  (1150, 1122, 568, 473, 1065, 471, 570, 966),
                  (1150, 1117, 566, 468, 1060, 466, 569, 958),
                  (1150, 1122, 569, 470, 1065, 467, 571, 963),
                  (1150, 1126, 568, 472, 1065, 470, 569, 965),
                  (1150, 1128, 570, 472, 1067, 470, 573, 964),
                  (1150, 1120, 567, 472, 1063, 471, 568, 964),
                  (1150, 1113, 562, 465, 1057, 464, 563, 955),
                  (1150, 1116, 566, 469, 1062, 466, 570, 963),
                  (1150, 1115, 563, 461, 1061, 460, 564, 955),
                  (1150, 1122, 567, 465, 1061, 463, 568, 956),
                  (1150, 1119, 563, 467, 1059, 466, 564, 959),
                  (1150, 1123, 567, 467, 1065, 465, 568, 961),
                  (1150, 1123, 564, 469, 1060, 469, 563, 960),
                  (1150, 1120, 565, 471, 1061, 469, 566, 965),
                  (1150, 1117, 564, 465, 1059, 464, 565, 956),
                  (1150, 1129, 568, 472, 1064, 472, 568, 967),
                  (1150, 1120, 564, 469, 1059, 470, 564, 961),
                  (1150, 1123, 563, 470, 1060, 468, 566, 963),
                  (1150, 1119, 565, 472, 1061, 469, 567, 965),
                  (1150, 1124, 565, 470, 1062, 469, 567, 964),
                  (1150, 1120, 561, 469, 1058, 469, 561, 963),
                  (1150, 1132, 565, 472, 1063, 473, 566, 968),
                  (1150, 1121, 567, 469, 1063, 468, 568, 961),
                  (1150, 1121, 566, 468, 1061, 464, 569, 960),
                  (1150, 1120, 562, 470, 1058, 467, 565, 962),
                  (1150, 1113, 565, 465, 1059, 460, 568, 953),
                  (1150, 1120, 567, 466, 1063, 464, 569, 957),
                  (1150, 1125, 563, 467, 1059, 466, 563, 960),
                  (1150, 1124, 566, 471, 1062, 469, 569, 963),
                  (1150, 1126, 570, 472, 1066, 470, 572, 966),
                  (1150, 1120, 561, 464, 1056, 463, 563, 957),
                  (1150, 1124, 569, 473, 1062, 468, 573, 966),
                  (1150, 1112, 563, 467, 1059, 463, 567, 959),
                  (1150, 1132, 566, 472, 1065, 470, 567, 968),
                  (1150, 1126, 565, 473, 1063, 470, 568, 967),
                  (1150, 1121, 568, 469, 1066, 466, 572, 964),
                  (1150, 1120, 565, 471, 1060, 470, 566, 963),
                  (1150, 1126, 572, 470, 1068, 466, 576, 963),
                  (1150, 1117, 565, 469, 1059, 467, 567, 961),
                  (1150, 1121, 566, 467, 1061, 465, 568, 962),
                  (1150, 1118, 566, 465, 1063, 463, 568, 958),
                  (1150, 1122, 561, 467, 1058, 464, 563, 961),
                  (1150, 1123, 563, 467, 1059, 465, 564, 960),
                  (1150, 1117, 564, 467, 1058, 464, 566, 959),
                  (1150, 1126, 569, 471, 1068, 468, 572, 965),
                  (1150, 1113, 564, 465, 1059, 462, 565, 957),
                  (1150, 1120, 566, 472, 1061, 470, 568, 965),
                  (1150, 1125, 567, 472, 1064, 467, 571, 966),
                  (1150, 1118, 567, 468, 1062, 464, 571, 959),
                  (1150, 1119, 565, 469, 1061, 466, 568, 962),
                  (1150, 1121, 565, 466, 1060, 464, 567, 957),
                  (1150, 1125, 563, 471, 1061, 471, 563, 966),
                  (1150, 1119, 562, 470, 1059, 469, 564, 963),
                  (1150, 1123, 563, 468, 1060, 468, 564, 962),
                  (1150, 1119, 567, 467, 1064, 465, 570, 960),
                  (1150, 1122, 567, 469, 1064, 468, 568, 962),
                  (1150, 1119, 568, 468, 1064, 465, 570, 961),
                  (1150, 1123, 564, 469, 1061, 467, 567, 963),
                  (1150, 1124, 566, 470, 1063, 469, 567, 964),
                  (1150, 1123, 568, 471, 1064, 468, 570, 964),
                  (1150, 1118, 568, 468, 1064, 467, 569, 961),
                  (1150, 1118, 569, 469, 1065, 467, 571, 962),
                  (1150, 1120, 569, 469, 1065, 467, 570, 962),
                  (1150, 1123, 571, 471, 1066, 468, 573, 964),
                  (1150, 1123, 568, 473, 1066, 472, 568, 967),
                  (1150, 1126, 569, 473, 1065, 470, 572, 967),
                  (1150, 1123, 566, 471, 1061, 471, 565, 964),
                  (1150, 1121, 566, 472, 1063, 469, 569, 966),
                  )

xc1=Ranger7A_Reticle[1][2]
yc1=Ranger7A_Reticle[1][3]
xr1=Ranger7A_Reticle[1][4]
yr1=yc1 #Ranger7A_Reticle[1][5]  #Force the image to be square, not following whatever skew image 1 has
xb1=xc1 #Ranger7A_Reticle[1][6]
yb1=Ranger7A_Reticle[1][7]

for tab,coords in enumerate(Ranger7A_Reticle):
    if tab>0:
        img=mpimg.imread("/home/jeppesen/workspace/pov/Ranger/7A/Ranger7A%03d.png"%tab)
        img=img*255 #Leave in floating-point, but scale so that everything is [0..255] instead of [0..1]. All pixels should be integral values.
        xc=coords[2]
        yc=coords[3]
        xr=coords[4]
        yr=coords[5]
        xb=coords[6]
        yb=coords[7]
        #Matrix which slides the pixels such that the center reticle of this image is at the origin
        To=np.array([[1,0,-yc],
                     [0,1,-xc],
                     [0,0,1]])
        #Matrix which puts the right reticle at ihat and the bottom at -jhat (inverse of matrix
        #which puts ihat at the right reticle and -jhat at the bottom)
        Dsm1=np.array([[(yr-yc),-(yb-yc),0],
                       [(xr-xc),-(xb-xc),0],
                       [0      ,0       ,1]])
        Ds=np.linalg.inv(Dsm1)
        #Matrix which puts ihat on the right reticle of tab 1 and -jhat on the bottom reticle of tab 1
        Rs=np.array([[(yr1-yc1),-(yb1-yc1),0],
                     [(xr1-xc1),-(xb1-xc1),0],
                     [0        ,0         ,1]])
        #Matrix which slides the pixels back such that the origin is at the center reticle of tab 1
        Tb=np.array([[1,0,yc1],
                     [0,1,xc1],
                     [0,0,1]])
        #Matrix which applies the above transforms in order
        M=Tb@Rs@Ds@To
        #M=Tb@To
        print(tab)
        Mimg=scipy.ndimage.affine_transform(img,np.linalg.inv(M)).astype(np.uint8)
        Mimg=Mimg[:1000,:]
        #plt.imshow(Mimg)
        #plt.show()
        img=Image.fromarray(Mimg, mode='L')
        img.save("/home/jeppesen/workspace/pov/Ranger/7A/Rect7A%03d.png"%tab)
